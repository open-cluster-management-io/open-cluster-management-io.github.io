<!DOCTYPE html>
<html><head>
  <meta charset="UTF-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css"/>
  <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/v2.1.1/mapbox-gl.css"/>
  <link rel="stylesheet" href="/main.css"/>
  <link rel="shortcut icon" type="image/svg" href="/ocm.svg">
  <title>Open Cluster Management</title>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4" crossorigin="anonymous"></script>
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-1PXKZXT157"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-1PXKZXT157');
  </script>
</head>
<body>
    <div class="container-fluid">
        <div class="row">



    


<input id="current-lang" type="hidden" value="zh">

<header class="navbar navbar-expand-md navbar-dark bd-navbar">
  <nav class="navbar navbar-expand-lg navbar-dark py-3 fixed-top">
    <div class="container-fluid flex-wrap flex-md-nowrap">
      <a href="/zh/" class="navbar-brand">
        <img src="/ocm.svg" alt="" width="30" height="24" class="align-text-top">
        Open Cluster Management
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navmenu">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navmenu">
        <ul class="navbar-nav ms-auto ">
          <li class="nav-item pe-2">
            <a href="/zh/community" class="nav-link text-light">社区</a>
          </li>
          <li class="nav-item pe-2">
            <a href="/zh/contribute" class="nav-link text-light">贡献</a>
          </li>
          <li class="nav-item pe-2">
            <a href="/zh/concepts" class="nav-link text-light">文档</a>
          </li>
          <li class="nav-item dropdown pe-2">
            
            <a class="nav-link dropdown-toggle text-light" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">中文</a>
            

            <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
              
              <li><a class="dropdown-item" href="#" id="to-en">English</a></li>
              
            </ul>
          </li>
          <li class="nav-item pe-2">
            <a class="nav-link text-light" href="https://www.youtube.com/c/OpenClusterManagement" target="_blank">
                <i class="bi bi-youtube"></i>
            </a>
          </li>
          <li class="nav-item pe-2">
            <a class="nav-link text-light" href="https://github.com/open-cluster-management-io" target="_blank">
              <i class="bi bi-github"></i>
            </a>
          </li>
          <li class="nav-item pe-2">
            <a class="nav-link text-light" href="https://kubernetes.slack.com/channels/open-cluster-mgmt" target="_blank">
              <i class="bi bi-slack"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>
</header>
</div>
        <div class="row subject-padding">
            <div class="col-2 col-md-3 padding-none sidebar-bgc">



    


<div class="sidebar-toggle sidebar-toggle-sm">
    <button type="button" id="sidebarToggle" class="btn btn-info">
        <i class="bi bi-list"></i>
    </button>
</div>
<nav id="sidebar" class="sidebar-hide-sm">
    <ul class="components">
        <li id="concepts">
            <a class="navlink" href="/zh/concepts">概念</a>
            <ul class="collapse">
                <li>
                    <a class="navlink" href="/zh/concepts/architecture">架构</a>
                </li>
                <li>
                    <a class="navlink" href="/zh/concepts/clusterclaim">集群声明</a>
                </li>
                <li>
                    <a class="navlink" href="/zh/concepts/managedcluster">托管集群</a>
                </li>
                <li>
                    <a class="navlink" href="/zh/concepts/manifestwork">资源下发</a>
                </li>
                <li>
                    <a class="navlink" href="/zh/concepts/managedclusterset">托管集群分组</a>
                </li>
                <li>
                    <a class="navlink" href="/zh/concepts/placement">匹配路由</a>
                </li>
                <li>
                    <a class="navlink" href="/zh/concepts/addon">自定义插件</a>
                </li>
                <li>
                    <a class="navlink" href="/zh/concepts/policy">Policy</a>
                </li>
            </ul>
        </li>
        <li id="getting-started">
            <a class="navlink" href="/zh/getting-started">安装</a>
            <ul class="collapse">
                <li>
                    <a class="navlink" href="/zh/getting-started/quick-start">快速开始</a>
                </li>
                <li>
                    <a class="navlink" href="/zh/getting-started/core">核心组件</a>
                    <ul class="collapse">
                        <li>
                            <a class="navlink" href="/zh/getting-started/core/cluster-manager">中枢控制器</a>
                        </li>
                        <li>
                            <a class="navlink" href="/zh/getting-started/core/register-cluster">集群代理控制器</a>
                        </li>
                    </ul>
                </li>
                <li>
                    <a class="navlink" href="/zh/getting-started/integration">插件和集成</a>
                    <ul class="collapse">
                        <li>
                            <a class="navlink" href="/zh/getting-started/integration/app-lifecycle">应用生命周期管理</a>
                        </li>
                        <li>
                            <a class="navlink" href="/zh/getting-started/integration/cluster-proxy">多集群网络隧道</a>
                        </li>
                        <li>
                            <a class="navlink" href="/zh/getting-started/integration/policy-framework">Policy框架</a>
                        </li>
                        <li>
                            <a class="navlink" href="/zh/getting-started/integration/policy-controllers">Policy控制器</a>
                        </li>
                        <li>
                            <a class="navlink" href="/zh/getting-started/integration/managed-serviceaccount">托管多集群ServiceAccount</a>
                        </li>
                    </ul>
                </li>
                <li>
                    <a class="navlink" href="/zh/getting-started/administration">运维管理</a>
                    <ul class="collapse">
                        <li>
                            <a class="navlink" href="/zh/getting-started/administration/upgrading">升级版本</a>
                        </li>
                    </ul>
                </li>
            </ul>
        </li>
        <li id="developer-guides">
            <a class="navlink" href="/zh/developer-guides">开发指南</a>
            <ul class="collapse">
                <li>
                    <a class="navlink" href="/zh/developer-guides/addon">Add-on 开发指南</a>
                </li>
                <li>
                    <a class="navlink" href="/zh/developer-guides/vscode-extension">VScode Extension</a>
                </li>
            </ul>
        </li>
        <li id="scenarios">
            <a class="navlink" href="/zh/scenarios">应用场景</a>
            <ul class="collapse">
                <li>
                    <a class="navlink" href="/zh/scenarios/deploy-kubernetes-resources">部署Kubernetes资源</a>
                </li>
                <li>
                    <a class="navlink" href="/zh/scenarios/distribute-workload-with-placement">通过placement分发工作负载</a>
                </li>
                <li>
                    <a class="navlink" href="/zh/scenarios/extend-multicluster-scheduling-capabilities">扩展多集群调度能力</a>
                </li>
                <li>
                    <a class="navlink" href="/zh/scenarios/extending-managed-clusters">扩展集群模型</a>
                </li>
                <li>
                    <a class="navlink" href="/zh/scenarios/integration-with-argocd">集成Argo CD</a>
                </li>                
                <li>
                    <a class="navlink" href="/zh/scenarios/pushing-kube-api-requests">向托管集群推送Kube API请求</a>
                </li>
            </ul>
        </li>
        <li id="community">
            <a class="navlink" href="/zh/community">社区</a>
            <ul class="collapse">
                <li>
                    <a class="navlink" href="/zh/community/releases">发行版本</a>
                </li>
                <li >
                    <a class="navlink" href="/zh/community/roadmap">社区规划</a>
                </li>
            </ul>
        </li>
        <li id="contribute">
            <a class="navlink" href="/zh/contribute">贡献</a>
        </li>
        <li id="blog">
            <a class="navlink" href="/zh/blog">博客</a>
        </li>
        <li style="padding-top: 10px; border-top: 2px solid #448a78;">
            <a class="navlink resource" href="https://github.com/open-cluster-management-io" target="_blank"><i class="bi bi-github"></i><span style="padding-left: 10px;">GitHub</span></a>
        </li>
        <li>
            <a class="navlink resource" href="https://kubernetes.slack.com/channels/open-cluster-mgmt" target="_blank"><i class="bi bi-slack"></i><span style="padding-left: 10px;">Slack</span></a>
        </li>
        <li>
            <a class="navlink resource" href="https://www.youtube.com/c/OpenClusterManagement" target="_blank"><i class="bi bi-youtube"></i><span style="padding-left: 10px;">YouTube</span></a>
        </li>
        <li>
            <a class="navlink resource" href="https://groups.google.com/g/open-cluster-management" target="_blank"><i class="bi bi-envelope-fill"></i><span style="padding-left: 10px;">Mailing group</span></a>
        </li>
        <li>
            <a class="navlink resource" href="https://calendar.google.com/calendar/u/0/embed?src=openclustermanagement@gmail.com" target="_blank"><i class="bi bi-calendar-event-fill"></i><span style="padding-left: 10px;">Community meetings</span></a>
        </li>
    </ul>
</nav>
<script type="text/javascript" src="/sidebar.js"></script>
</div>
            <div class="col-10 col-md-9 padding-none">
<div id="content">
    <h1>托管多集群ServiceAccount</h1>
    <!-- spellchecker-disable -->



  <div class="gdoc-toc gdoc-toc__level--6"><nav id="TableOfContents"><ul>
        <li><a href="#background">Background</a></li>
        <li><a href="#prerequisite">Prerequisite</a></li>
        <li><a href="#installation">Installation</a></li>
        <li><a href="#usage">Usage</a></li>
        <li><a href="#related-materials">Related materials</a></li>
      </ul></nav><hr></div>


<!-- spellchecker-enable -->
<p><a href="https://github.com/open-cluster-management-io/managed-serviceaccount">Managed Service Account</a>
is an OCM addon enabling a hub cluster admin to manage <a href="https://kubernetes.io/docs/reference/access-authn-authz/service-accounts-admin/">service account</a>
across multiple clusters on ease. By controlling the creation and removal of
the service account, the addon agent will project and rotate the corresponding
token back to the hub cluster which is very useful for the Kube API client from
the hub cluster to request against the managed clusters.</p>
<h2 id="background">Background</h2>
<p>Normally there are two major approaches for a Kube API client to authenticate
and access a Kubernetes cluster:</p>
<ul>
<li>Valid X.509 certificate-key pair</li>
<li>Service account bearer token</li>
</ul>
<p>The service account token will be automatically persisted as a secret
resource inside the hosting Kubernetes clusters upon creation, which is commonly
used for the <a href="https://github.com/kubernetes/client-go/tree/master/examples/in-cluster-client-configuration">&ldquo;in-cluster&rdquo;</a>
client. However, in terms of OCM, the hub cluster is completely an external
system to the managed clusters, so we will need a local agent in each managed
cluster to reflect the tokens consistently to the hub cluster so that the
Kube API client from hub cluster can &ldquo;push&rdquo; the requests directly against the
managed cluster. By delegating the multi-cluster service account management to
this addon, we can:</p>
<ul>
<li>Project the service account token from the managed clusters to the hub cluster
with custom API audience.</li>
<li>Rotate the service account tokens dynamically.</li>
<li>Homogenize the client identities so that we can easily write a static RBAC
policy that applies to multiple managed clusters.</li>
</ul>
<h2 id="prerequisite">Prerequisite</h2>
<p>You must meet the following prerequisites to install the managed service
account:</p>
<ul>
<li>
<p>Ensure your <code>open-cluster-management</code> release is greater than <code>v0.5.0</code>.</p>
</li>
<li>
<p>Ensure <a href="https://kubernetes.io/docs/tasks/tools/install-kubectl"><code>kubectl</code></a> is installed.</p>
</li>
<li>
<p>Ensure <a href="https://helm.sh/docs/intro/install/"><code>helm</code></a> is installed.</p>
</li>
</ul>
<h2 id="installation">Installation</h2>
<p>To install the managed service account addon to the OCM control plane, run:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ helm repo add ocm https://openclustermanagement.blob.core.windows.net/releases/
$ helm repo update
$ helm search repo ocm
NAME                              	CHART VERSION	APP VERSION	DESCRIPTION                                   
ocm/managed-serviceaccount          0.2.0           1.0.0       A Helm chart <span style="color:#66d9ef">for</span> Managed ServiceAccount Addon
...
</code></pre></div><p>Then run the following helm command to continue the installation:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ helm install -n open-cluster-management-addon --create-namespace <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    managed-serviceaccount  ocm/managed-serviceaccount
$ kubectl -n open-cluster-management-addon get pod
NAME                                                    READY   STATUS    RESTARTS   AGE
managed-serviceaccount-addon-manager-559c95b7d8-xsb94   1/1     Running   <span style="color:#ae81ff">1</span>          4d4h 
...
</code></pre></div><p>By default, the addon manager will be automatically discovering the addition or
removal the managed clusters and installs the managed serviceaccount agents into
them on the fly. To check out the healthiness status of the managed serviceaccount
agents, we can run:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ kubectl get managedclusteraddon -A
NAMESPACE         NAME                     AVAILABLE   DEGRADED   PROGRESSING
&lt;cluster name&gt;    managed-serviceaccount   True  
</code></pre></div><h2 id="usage">Usage</h2>
<p>To exercise the new <code>ManagedServiceAccount</code> API introduced by this addon, we
can start by applying the following sample resource:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ export CLUSTER_NAME<span style="color:#f92672">=</span>&lt;cluster name&gt;
$ kubectl create -f - <span style="color:#e6db74">&lt;&lt;EOF
</span><span style="color:#e6db74">apiVersion: authentication.open-cluster-management.io/v1alpha1
</span><span style="color:#e6db74">kind: ManagedServiceAccount
</span><span style="color:#e6db74">metadata:
</span><span style="color:#e6db74">  name: my-sample
</span><span style="color:#e6db74">  namespace: ${CLUSTER_NAME}
</span><span style="color:#e6db74">spec:
</span><span style="color:#e6db74">  rotation: {}
</span><span style="color:#e6db74">EOF</span>
</code></pre></div><p>Then the addon agent in each of the managed cluster is responsible for
executing and refreshing the status of the <code>ManagedServiceAccount</code>, e.g.:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ kubectl describe ManagedServiceAccount -n cluster1
...
  status:
    conditions:
    - lastTransitionTime: <span style="color:#e6db74">&#34;2021-12-09T09:08:15Z&#34;</span>
      message: <span style="color:#e6db74">&#34;&#34;</span>
      reason: TokenReported
      status: <span style="color:#e6db74">&#34;True&#34;</span>
      type: TokenReported
    - lastTransitionTime: <span style="color:#e6db74">&#34;2021-12-09T09:08:15Z&#34;</span>
      message: <span style="color:#e6db74">&#34;&#34;</span>
      reason: SecretCreated
      status: <span style="color:#e6db74">&#34;True&#34;</span>
      type: SecretCreated
    expirationTimestamp: <span style="color:#e6db74">&#34;2022-12-04T09:08:15Z&#34;</span>
    tokenSecretRef:
      lastRefreshTimestamp: <span style="color:#e6db74">&#34;2021-12-09T09:08:15Z&#34;</span>
      name: my-sample
</code></pre></div><p>The service account will be created in the managed cluster (assume the name is <code>cluster1</code>):</p>
<pre><code>$ kubectl get sa my-sample -n open-cluster-management-managed-serviceaccount --context kind-cluster1
NAME        SECRETS   AGE
my-sample   1         9m57s
</code></pre><p>The corresponding secret will also be created in the hub cluster, which is
visible via:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ kubectl -n &lt;your cluster&gt; get secret my-sample  
NAME        TYPE     DATA   AGE
my-sample   Opaque   <span style="color:#ae81ff">2</span>      2m23s
</code></pre></div><h2 id="related-materials">Related materials</h2>
<p>Repo: <a href="https://github.com/open-cluster-management-io/managed-serviceaccount">https://github.com/open-cluster-management-io/managed-serviceaccount</a></p>
<p>See the design proposal at: <a href="https://github.com/open-cluster-management-io/enhancements/tree/main/enhancements/sig-architecture/19-projected-serviceaccount-token">https://github.com/open-cluster-management-io/enhancements/tree/main/enhancements/sig-architecture/19-projected-serviceaccount-token</a></p>

</div>
<script type="text/javascript" src="/clipboard-copy.js"></script>
</div>
        </div>
        <div class="row"><nav class="ocm navbar navbar-expand-lg navbar-dark py-3">
  <div class="container-fluid flex-wrap flex-md-nowrap">
    <div class="text-light">&copy; 2021 Open Cluster Management Authors. The Linux Foundation® (TLF) has registered trademarks and uses trademarks. For a list of TLF trademarks, see <a href="https://www.linuxfoundation.org/trademark-usage/" target="_blank" style="color: #f8f9fa;">Trademark Usage</a></div>
  </div>
</nav>
<script type="text/javascript" src="/lang.js"></script>
</div>
    </div>
</body>
</html>
